# Report Generation Module

This module provides a standardized way to generate markdown reports for all campaign scripts (`fill-the-table`, `return-to-table`, `seat-newcomers`).

## Key Function

### `generate_report()`

The main function that generates a complete markdown report for a campaign run.

**Function Signature:**
```python
def generate_report(
    users: List[Dict[str, Any]],
    events: List[Dict[str, Any]],
    matches: List[Dict[str, Any]],
    messages: List[Dict[str, Any]],
    goal: str,
    campaign_id: str,
    campaign_name: str,
    user_filtering_explanation: str,
    event_filtering_explanation: str,
    matching_prompt: str,
    message_generation_prompt: str,
    assessment: Optional[Dict[str, Any]] = None,
    recommendations: Optional[List[str]] = None,
    user_display_fields: Optional[Dict[str, str]] = None,
    event_display_fields: Optional[Dict[str, str]] = None
) -> str
```

## Required Parameters

### Data Arrays
- **`users`**: List of filtered user dictionaries. Each user must have a `summary` field (generated by `generate_user_summary()`).
- **`events`**: List of filtered event dictionaries. Each event must have a `summary` field (generated by `generate_event_summary()`).
- **`matches`**: List of match dictionaries with `user_name`, `event_name`, `confidence_percentage`, and `reasoning` fields.
- **`messages`**: List of message dictionaries with `user_name`, `message_text`, `confidence_percentage`/`similarity_score`, and optionally `reasoning` fields.

### Campaign Information
- **`goal`**: Campaign goal statement (string)
- **`campaign_id`**: Unique campaign identifier (e.g., `"fill-the-table-20251214-121030"`)
- **`campaign_name`**: Campaign name (e.g., `"fill-the-table"`)

### Filtering Explanations
- **`user_filtering_explanation`**: Detailed explanation of how users were filtered/selected (string)
- **`event_filtering_explanation`**: Detailed explanation of how events were filtered/selected (string)

### Prompts
- **`matching_prompt`**: The full prompt template used for matching users to events (string)
- **`message_generation_prompt`**: The full prompt template used for generating personalized messages (string)

## Optional Parameters

- **`assessment`**: Dictionary with keys: `assessment`, `strengths`, `recommendations`, `focus_areas`
- **`recommendations`**: List of recommendation strings (alternative to `assessment`)
- **`user_display_fields`**: Dict mapping field names to display labels (e.g., `{'eventCount': 'events', 'reactivation_score': 'score'}`)
- **`event_display_fields`**: Dict mapping field names to display labels for events

## Expected Data Structure

### User Dictionary
Each user dictionary should include:
- `firstName`, `lastName` (for name display)
- `summary` (required - generated summary sentence)
- Campaign-specific fields like:
  - `eventCount` (fill-the-table, return-to-table, seat-newcomers)
  - `newcomer_score` (seat-newcomers)
  - `reactivation_score` (return-to-table)
  - `days_inactive` (return-to-table)
  - `days_since_join` (seat-newcomers)
  - `is_first_timer` (seat-newcomers)
  - `homeNeighborhood` (for location display)

### Event Dictionary
Each event dictionary should include:
- `name` (event name)
- `startDate` (event start date)
- `neighborhood` (event location)
- `maxParticipants` (capacity)
- `participants` (list of participant IDs)
- `participationPercentage` (calculated fill percentage)
- `summary` (required - generated summary sentence)

### Match Dictionary
Each match dictionary should include:
- `user_name` (full name)
- `event_name` (event name)
- `confidence_percentage` (match confidence 0-100)
- `reasoning` (explanation of the match)

### Message Dictionary
Each message dictionary should include:
- `user_name` (full name)
- `message_text` (the generated message)
- `confidence_percentage` or `similarity_score` (confidence score)
- `reasoning` (optional - explanation of message generation)

## Report Structure

The generated report includes the following sections (in order):

1. **Goal** - Campaign goal statement
2. **Run Summary** - Campaign ID, counts of users/events/matches/messages
3. **Filtered Users** - All filtered users with summaries and filtering explanation
4. **Filtered Events** - All filtered events with summaries and filtering explanation
5. **Matches and Reasoning** - All matches with confidence scores and reasoning
6. **Messages** - All generated messages with confidence scores
7. **Key Prompts Used** - Matching and message generation prompts (in code blocks)
8. **Assessment & Recommendations** - Optional assessment or recommendations

## Usage Example

```python
from helpers.report_creation.report_generator import generate_report

# In your campaign's _write_markdown_report() method:
markdown_content = generate_report(
    users=users,
    events=events,
    matches=matches,
    messages=messages,
    goal="Your campaign goal",
    campaign_id=self.campaign_id,
    campaign_name=self.campaign_name,
    user_filtering_explanation="Users were filtered for...",
    event_filtering_explanation="Events were filtered for...",
    matching_prompt=self.matching_prompt_template,
    message_generation_prompt=self.message_generation_prompt_template,
    recommendations=self._get_recommendations(),
    user_display_fields={'eventCount': 'events'}
)

with open(report_file, 'w', encoding='utf-8') as f:
    f.write(markdown_content)
```

## Notes

- Users and events **must** have `summary` fields populated before calling `generate_report()`
- Prompts should be captured as class attributes during matching/message generation
- The function returns a markdown string that can be written directly to a file
- All sections are automatically formatted with proper markdown syntax
